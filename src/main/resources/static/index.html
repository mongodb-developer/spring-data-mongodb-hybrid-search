<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="utf-8" />
    <title>Movie Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-bottom: 4rem; }
        .search-card { position: sticky; top: 0; z-index: 100; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom">
    <div class="container">
        <a class="navbar-brand fw-semibold" href="#">ðŸŽ¬ Movie Search</a>
    </div>
</nav>

<main class="container my-4">
    <div class="card shadow-sm search-card mb-4">
        <div class="card-body">
            <form id="search-form" class="row g-2">
                <div class="col-12">
                    <label for="q" class="form-label mb-1">Search term</label>
                    <div class="input-group w-100">
                        <input id="q" name="query" class="form-control" type="text"
                               placeholder="e.g., pyramids space travel" required />
                        <button id="btn-search" class="btn btn-primary" type="submit">
                            Search
                        </button>
                    </div>
                    <div class="d-flex justify-content-end">
                        <small id="status" class="text-muted mt-1"></small>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="alerts"></div>
    <div id="results" class="row g-3"></div>
</main>

<footer class="container text-center text-muted">
    <small>Movie search powered by Spring technologies, Voyage AI, and MongoDB Vector Search.</small>
</footer>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const form = document.getElementById('search-form');
    const input = document.getElementById('q');
    const btn = document.getElementById('btn-search');
    const results = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const alerts = document.getElementById('alerts');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const q = input.value.trim();
        if (!q) return;

        setBusy(true);
        clearUI();

        try {
            const resp = await fetch('/movies?query=' + encodeURIComponent(q), {
                headers: { 'Accept': 'application/json' }
            });
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const data = await resp.json();

            if (!Array.isArray(data) || data.length === 0) {
                showAlert('No results found.', 'warning');
                return;
            }

            statusEl.textContent = `Found ${data.length} result${data.length > 1 ? 's' : ''}.`;
            renderResults(data);
        } catch (err) {
            showAlert('Error fetching movies: ' + esc(err.message), 'danger');
        } finally {
            setBusy(false);
        }
    });

    function renderResults(items) {
        for (const m of items) {
            const title = pick(m, ['title', 'name']) || '(untitled)';
            const year = pick(m, ['year', 'releasedYear', 'releaseYear']);
            const fullplot = pick(m, ['fullplot', 'fullPlot', 'plot']) || '';

            const col = document.createElement('div');
            col.className = 'col-12';

            const card = document.createElement('div');
            card.className = 'card shadow-sm';

            const body = document.createElement('div');
            body.className = 'card-body';

            const header = document.createElement('div');
            header.className = 'd-flex align-items-center gap-2 flex-wrap';

            const h5 = document.createElement('h5');
            h5.className = 'card-title mb-0';
            h5.textContent = title;

            header.appendChild(h5);

            if (year) {
                const badge = document.createElement('span');
                badge.className = 'badge text-bg-secondary';
                badge.textContent = year;
                header.appendChild(badge);
            }



            const p = document.createElement('p');
            p.className = 'card-text text-body-secondary mt-2 movie-plot';
            p.textContent = fullplot;

            body.appendChild(header);
            body.appendChild(p);
            card.appendChild(body);
            col.appendChild(card);
            results.appendChild(col);
        }
    }

    function setBusy(isBusy) {
        btn.disabled = isBusy;
        input.disabled = isBusy;
        statusEl.innerHTML = isBusy
            ? '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Searchingâ€¦'
            : '';
    }

    function clearUI() {
        alerts.innerHTML = '';
        results.innerHTML = '';
        statusEl.textContent = '';
    }

    function showAlert(msg, type = 'info') {
        const div = document.createElement('div');
        div.className = `alert alert-${type}`;
        div.textContent = msg;
        alerts.appendChild(div);
    }

    function esc(str) {
        return String(str ?? '').replace(/[&<>"']/g, s => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[s]));
    }

    function pick(obj, keys) {
        for (const k of keys) {
            if (obj && obj[k] != null && String(obj[k]).trim() !== '') {
                return obj[k];
            }
        }
        return undefined;
    }

</script>
</body>
</html>
